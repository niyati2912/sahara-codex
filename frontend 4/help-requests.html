<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Help Requests - SAHARA</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f0faff, #d4f1ff);
      color: #003366;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: #e0f7ff; 
      padding: 30px 20px;
      text-align: center;
      font-size: 2em;
      font-weight: 600;
      color: #048ab6;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .categories {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 14px;
      margin: 20px auto;
      max-width: 90%;
    }

    .category {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid #cce5ff;
      border-radius: 12px;
      padding: 8px 18px;
      color: #007acc;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .category:hover, .category.active {
      transform: scale(1.05);
      background-color: #085c78;
      color: white;
    }

    .request-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      padding: 40px 20px;
      flex: 1;
    }

    .request-card {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 102, 170, 0.1);
      width: 330px;
      padding: 25px 20px;
      text-align: left;
      position: relative;
    }

    .request-card h3 {
      margin-bottom: 10px;
      color: #007acc;
      font-size: 1.2em;
    }

    .map-link {
      display: inline-block;
      margin-top: 12px;
      font-size: 0.9em;
      color: #007acc;
      text-decoration: underline;
      cursor: pointer;
    }

    .button-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 18px;
    }

    .help-button, .chat-button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .help-button {
      background-color: #1aa4d1;
      color: white;
    }

    .chat-button {
      background-color: #e3f5ff;
      color: #0d7cc6;
    }

    .notification {
      margin-top: 12px;
      color: green;
      font-size: 0.9em;
      font-weight: bold;
    }

    footer {
      text-align: center;
      padding: 20px;
      background-color: #e0f0ff;
      color: #003366;
      font-size: 0.95em;
      margin-top: auto;
    }

    /* Real-time Chat Popup */
    .chat-popup {
      position: fixed;
      bottom: 20px;
      right: 30px;
      width: 380px;
      height: 550px;
      background-color: white;
      border: 2px solid #007acc;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      z-index: 999;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #007acc, #0099ff);
      color: white;
      padding: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header h4 {
      margin: 0;
      font-size: 1.1em;
      display: flex;
      align-items: center;
    }

    .online-status {
      width: 10px;
      height: 10px;
      background-color: #4caf50;
      border-radius: 50%;
      margin-left: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }

    .close-chat {
      background: none;
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      padding: 5px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }

    .close-chat:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: linear-gradient(to bottom, #f8f9fa, #ffffff);
    }

    .message {
      margin-bottom: 15px;
      padding: 12px 15px;
      border-radius: 18px;
      max-width: 85%;
      word-wrap: break-word;
      position: relative;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.sent {
      background: linear-gradient(135deg, #007acc, #0099ff);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }

    .message.received {
      background: linear-gradient(135deg, #e3f2fd, #f3f4f6);
      color: #333;
      border-bottom-left-radius: 5px;
      border: 1px solid #e0e0e0;
    }

    .message-time {
      font-size: 0.75em;
      opacity: 0.8;
      margin-top: 5px;
      text-align: right;
    }

    .message.received .message-time {
      text-align: left;
    }

    .chat-input-container {
      padding: 20px;
      border-top: 2px solid #f0f0f0;
      background-color: white;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      padding: 12px 18px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      outline: none;
      font-size: 0.95em;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.3s;
    }

    .chat-input:focus {
      border-color: #007acc;
    }

    .send-button {
      background: linear-gradient(135deg, #007acc, #0099ff);
      color: white;
      border: none;
      padding: 12px 18px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      min-width: 70px;
      transition: transform 0.2s;
    }

    .send-button:hover {
      transform: scale(1.05);
    }

    .send-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .typing-indicator {
      padding: 15px;
      font-style: italic;
      color: #666;
      font-size: 0.9em;
      display: flex;
      align-items: center;
    }

    .typing-dots {
      display: inline-flex;
      margin-left: 8px;
    }

    .typing-dots span {
      height: 8px;
      width: 8px;
      background-color: #007acc;
      border-radius: 50%;
      margin: 0 2px;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Connection Status */
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
      z-index: 1000;
    }

    .connection-status.online {
      background-color: #4caf50;
      color: white;
    }

    .connection-status.offline {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div class="connection-status" id="connectionStatus">🔄 Connecting...</div>

  <header>Help Requests - Real-time Chat</header>

  <div class="categories">
    <div class="category active" onclick="filterCategory('All', event)">All</div>
    <div class="category" onclick="filterCategory('Medical', event)">Medical</div>
    <div class="category" onclick="filterCategory('Emotional', event)">Emotional</div>
    <div class="category" onclick="filterCategory('Safety', event)">Safety</div>
    <div class="category" onclick="filterCategory('Technical', event)">Technical</div>
    <div class="category" onclick="filterCategory('Lost/Stranded', event)">Lost/Stranded</div>
    <div class="category" onclick="filterCategory('Women/LGBTQ+', event)">Women/LGBTQ+</div>
  </div>

  <div class="request-list" id="requestList"></div>

  <div class="chat-popup" id="chatBox">
    <div class="chat-header">
      <h4 id="chatTitle">
        Chat
        <span class="online-status"></span>
      </h4>
      <button class="close-chat" onclick="closeChat()">×</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="typing-indicator" id="typingIndicator" style="display: none;">
        User is typing
        <div class="typing-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
    <div class="chat-input-container">
      <input 
        type="text" 
        id="chatInput" 
        class="chat-input" 
        placeholder="Type your message..." 
        onkeypress="handleKeyPress(event)" 
      />
      <button class="send-button" id="sendButton" onclick="sendMessage()">Send</button>
    </div>
  </div>

  <footer>
    <p>© 2025 SAHARA Community | Real-time Help System</p>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>

  <script>
    
    const firebaseConfig = {
    apiKey: "AIzaSyD6vqtV6apJ41XKyOjYxEIeIzt_DmaLnq0",
      authDomain: "sahara-cb829.firebaseapp.com",
      projectId: "sahara-cb829",
      storageBucket: "sahara-cb829.firebasestorage.app",
      messagingSenderId: "245992709744",
      appId: "1:245992709744:web:a96331ce109d79844fdeb5",
      measurementId: "G-G5LXE5110B"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Sample help requests
    const requests = [
      { 
        id: 'user1', 
        name: 'Riya Sharma', 
        help: 'Emotional Support', 
        location: 'Delhi University Hostel', 
        type: 'Emotional', 
        message: 'Having panic attack & alone in room. Need someone to talk to urgently.' 
      },
      { 
        id: 'user2', 
        name: 'Mohit Verma', 
        help: 'Medical Emergency', 
        location: 'Pune Station', 
        type: 'Medical', 
        message: 'Diabetic emergency - out of insulin, feeling dizzy. No emergency contact reachable.' 
      },
      { 
        id: 'user3', 
        name: 'Arun & Sameer', 
        help: 'Stranded Late Night', 
        location: 'Sector 56, Gurgaon', 
        type: 'Lost/Stranded', 
        message: 'Cab broke down at midnight, phone battery dying. Need safe transport or location tracking.' 
      },
      { 
        id: 'user4', 
        name: 'Aarti Joshi', 
        help: 'Safety Threat', 
        location: 'MG Road, Bangalore', 
        type: 'Safety', 
        message: 'Being followed after leaving office late. Feel very unsafe, need immediate help.' 
      },
      { 
        id: 'user5', 
        name: 'Dev Mehta', 
        help: 'Tech SOS Help', 
        location: 'Noida Sector 18', 
        type: 'Technical', 
        message: 'SOS app crashed during emergency. Cannot send location alert. Need technical support urgently.' 
      },
      { 
        id: 'user6', 
        name: 'Sneha & Kavya', 
        help: 'Women Support', 
        location: 'Mumbai Central Station', 
        type: 'Women/LGBTQ+', 
        message: 'Harassment in train compartment. Feel threatened and unsafe. Need support and guidance.' 
      }
    ];

    // Chat variables
    let activeChatUser = "";
    let currentChatId = "";
    let helperId = "helper_" + Math.random().toString(36).substr(2, 9);
    let messageListener = null;
    let typingTimeout = null;
    let connectionStatus = 'connecting';

    // Initialize connection status
    function updateConnectionStatus(status) {
      const statusEl = document.getElementById('connectionStatus');
      connectionStatus = status;
      
      if (status === 'online') {
        statusEl.textContent = '🟢 Connected';
        statusEl.className = 'connection-status online';
      } else if (status === 'offline') {
        statusEl.textContent = '🔴 Disconnected';
        statusEl.className = 'connection-status offline';
      } else {
        statusEl.textContent = '🔄 Connecting...';
        statusEl.className = 'connection-status';
      }
    }

    // Filter help requests by category
    function filterCategory(type, e) {
      document.querySelectorAll('.category').forEach(cat => cat.classList.remove('active'));
      e.target.classList.add('active');
      
      const list = document.getElementById('requestList');
      list.innerHTML = '';
      
      const filtered = type === 'All' ? requests : requests.filter(req => req.type === type);
      filtered.forEach((req, idx) => list.appendChild(createCard(req, idx)));
    }

    // Create help request card
    function createCard(req, index) {
      const card = document.createElement('div');
      card.className = 'request-card';
      card.id = `card-${index}`;
      card.innerHTML = `
        <h3>${req.name}</h3>
        <p><strong>Help Needed:</strong> ${req.help}</p>
        <p><strong>Location:</strong> ${req.location}</p>
        <p><em>${req.message}</em></p>
        <span class="map-link" onclick="viewMap('${req.location}')">📍 View on Map</span>
        <div class="button-row">
          <button class="help-button" onclick="helpNow('${req.name}', 'card-${index}')">🚨 Help Now</button>
          <button class="chat-button" onclick="startChat('${req.name}', '${req.id}')">💬 Start Chat</button>
        </div>
      `;
      return card;
    }

    // Send help notification
    function helpNow(name, cardId) {
      const card = document.getElementById(cardId);
      const msg = document.createElement('div');
      msg.className = 'notification';
      msg.textContent = `✅ Emergency notification sent to ${name}`;
      
      const old = card.querySelector('.notification');
      if (old) old.remove();
      card.appendChild(msg);

      // Auto-remove notification after 5 seconds
      setTimeout(() => {
        if (msg.parentNode) msg.remove();
      }, 5000);
    }

    // Start real-time chat with user
    function startChat(name, userId) {
      activeChatUser = name;
      currentChatId = `chat_${userId}_${helperId}`;
      
      document.getElementById("chatTitle").innerHTML = `${name} <span class="online-status"></span>`;
      document.getElementById("chatBox").style.display = "flex";
      document.getElementById("chatInput").focus();
      
      // Clear existing messages
      const messagesContainer = document.getElementById("chatMessages");
      messagesContainer.innerHTML = '<div class="typing-indicator" id="typingIndicator" style="display: none;">User is typing<div class="typing-dots"><span></span><span></span><span></span></div></div>';
      
      // Remove previous listeners
      if (messageListener) {
        messageListener.off();
      }
      
      // Set up real-time message listener
      messageListener = database.ref(`chats/${currentChatId}/messages`);
      messageListener.on('child_added', function(snapshot) {
        const message = snapshot.val();
        displayMessage(message);
      });
      
      // Listen for typing indicators
      database.ref(`chats/${currentChatId}/typing`).on('value', function(snapshot) {
        const typingData = snapshot.val();
        const typingIndicator = document.getElementById('typingIndicator');
        
        if (typingData && typingData.user && typingData.user !== helperId) {
          typingIndicator.style.display = 'flex';
        } else {
          typingIndicator.style.display = 'none';
        }
      });
      
      // Initialize chat in Firebase
      database.ref(`chats/${currentChatId}`).once('value').then(function(snapshot) {
        if (!snapshot.exists()) {
          database.ref(`chats/${currentChatId}`).set({
            participants: {
              user: userId,
              helper: helperId,
              userName: name,
              helperName: "Support Helper"
            },
            created: firebase.database.ServerValue.TIMESTAMP,
            status: 'active',
            lastActivity: firebase.database.ServerValue.TIMESTAMP
          });
          
          // Send welcome message
          setTimeout(() => {
            const welcomeMessage = {
              text: `Hi ${name}! I'm here to help you. How can I assist you right now?`,
              sender: helperId,
              senderName: "Helper",
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              type: 'text'
            };
            database.ref(`chats/${currentChatId}/messages`).push(welcomeMessage);
          }, 1000);
        }
      });

      // Simulate user messages for demo
      simulateUserActivity(currentChatId, name);
    }

    // Close chat
    function closeChat() {
      document.getElementById("chatBox").style.display = "none";
      
      // Remove listeners
      if (messageListener) {
        messageListener.off();
        messageListener = null;
      }
      
      if (currentChatId) {
        database.ref(`chats/${currentChatId}/typing`).off();
        database.ref(`chats/${currentChatId}/typing/${helperId}`).remove();
      }
      
      activeChatUser = "";
      currentChatId = "";
    }

    // Send message to Firebase
    function sendMessage() {
      const input = document.getElementById("chatInput");
      const messageText = input.value.trim();
      
      if (messageText && currentChatId && connectionStatus === 'online') {
        const message = {
          text: messageText,
          sender: helperId,
          senderName: "Helper",
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          type: 'text'
        };
        
        // Send to Firebase
        database.ref(`chats/${currentChatId}/messages`).push(message);
        
        // Update last activity
        database.ref(`chats/${currentChatId}/lastActivity`).set(firebase.database.ServerValue.TIMESTAMP);
        
        // Clear input and typing indicator
        input.value = "";
        database.ref(`chats/${currentChatId}/typing/${helperId}`).remove();
        
        // Update chat metadata
        database.ref(`chats/${currentChatId}/lastMessage`).set({
          text: messageText,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          sender: helperId,
          senderName: "Helper"
        });
      }
    }

    // Display message in chat
    function displayMessage(message) {
      const messagesContainer = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      
      const messageDiv = document.createElement('div');
      messageDiv.className = message.sender === helperId ? 'message sent' : 'message received';
      
      const time = message.timestamp ? 
        new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
        'Now';
      
      messageDiv.innerHTML = `
        <div>${message.text}</div>
        <div class="message-time">${time}</div>
      `;
      
      // Insert before typing indicator
      messagesContainer.insertBefore(messageDiv, typingIndicator);
      
      // Scroll to bottom smoothly
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Handle keyboard input
    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
        return;
      }
      
      // Handle typing indicator
      if (currentChatId && connectionStatus === 'online') {
        database.ref(`chats/${currentChatId}/typing/${helperId}`).set(true);
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          database.ref(`chats/${currentChatId}/typing/${helperId}`).remove();
        }, 2000);
      }
    }

    // Open location in Google Maps
    function viewMap(location) {
      const query = encodeURIComponent(location);
      window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, '_blank');
    }

    // Simulate user activity for demo
    function simulateUserActivity(chatId, userName) {
      const userMessages = [
        "Hello, is anyone there? I really need help right now.",
        "Thank you for responding so quickly!",
        "I'm feeling a bit better knowing someone is here.",
        "Can you please stay with me for a few more minutes?",
        "This chat system is working great, I feel supported."
      ];
      
      let messageIndex = 0;
      
      function sendUserMessage() {
        if (messageIndex < userMessages.length && currentChatId === chatId) {
          // Show typing indicator
          database.ref(`chats/${chatId}/typing/user`).set(true);
          
          setTimeout(() => {
            // Remove typing indicator and send message
            database.ref(`chats/${chatId}/typing/user`).remove();
            
            const message = {
              text: userMessages[messageIndex],
              sender: "user",
              senderName: userName,
              timestamp: firebase.database.ServerValue.TIMESTAMP,
              type: 'text'
            };
            
            database.ref(`chats/${chatId}/messages`).push(message);
            messageIndex++;
            
            // Schedule next message
            if (messageIndex < userMessages.length) {
              setTimeout(sendUserMessage, Math.random() * 15000 + 10000); // 10-25 seconds
            }
          }, Math.random() * 3000 + 2000); // 2-5 seconds typing
        }
      }
      
      // Start first message after delay
      setTimeout(sendUserMessage, Math.random() * 5000 + 3000); // 3-8 seconds initial delay
    }

    // Initialize application
    window.onload = () => {
      // Load all help requests
      filterCategory('All', { target: document.querySelector('.category.active') });
      
      // Set up Firebase connection monitoring
      database.ref('.info/connected').on('value', function(snapshot) {
        if (snapshot.val() === true) {
          updateConnectionStatus('online');
          
          // Set helper status
          database.ref(`helpers/${helperId}`).set({
            name: "Support Helper",
            status: "online",
            lastSeen: firebase.database.ServerValue.TIMESTAMP,
            connectedAt: firebase.database.ServerValue.TIMESTAMP
          });
          
          // Remove helper when disconnected
          database.ref(`helpers/${helperId}`).onDisconnect().update({
            status: "offline",
            lastSeen: firebase.database.ServerValue.TIMESTAMP
          });
          
        } else {
          updateConnectionStatus('offline');
        }
      });
      
      // Handle page close
      window.addEventListener('beforeunload', function() {
        if (currentChatId) {
          database.ref(`chats/${currentChatId}/typing/${helperId}`).remove();
        }
        database.ref(`helpers/${helperId}/status`).set("offline");
      });
    };
  </script>
</body>
</html>