<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Danger Zone — Report & Find</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  :root{
    --bg1:#2a0000; --bg2:#000000;
    --accent:#ff4d4d; --accent-2:#d11a2a; --muted:#111; --card:#0a0a0a;
    --text:#ffffff; --sub:#dddddd;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Poppins',sans-serif; color:var(--text);
    background: radial-gradient(1200px 600px at 80% -10%, rgba(255,77,77,.12), transparent 60%),
                linear-gradient(135deg,var(--bg1),var(--bg2));
    min-height:100vh; padding:16px;
  }
  .shell{max-width:1100px;margin:0 auto}
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px 0 18px; border-bottom:1px solid rgba(255,255,255,.08);
  }
  .brand{font-weight:800; letter-spacing:.5px; font-size:1.25rem}
  .badge{background:rgba(255,77,77,.15); color:#ffd1d1; padding:.25rem .5rem; border-radius:999px; font-size:.75rem}
  h1{margin:.5rem 0 0; font-size:1.8rem}
  p.lead{color:var(--sub); margin:.35rem 0 0; font-size:.95rem}
  .tabs{
    display:flex; gap:10px; margin:18px 0;
  }
  .tab{
    flex:1; text-align:center; padding:12px 14px; cursor:pointer; font-weight:600;
    border-radius:10px; background:#1a1a1a; border:1px solid #222; transition:.2s;
  }
  .tab.active{background:#2a2a2a; border-color:#333; box-shadow:0 0 0 2px rgba(255,77,77,.15) inset}
  .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:16px; backdrop-filter: blur(4px);
    box-shadow:0 10px 30px rgba(0,0,0,.25);
  }
  .card h2{margin:0 0 10px; font-size:1.1rem}
  label{display:block; margin:12px 0 6px; font-weight:600; font-size:.9rem}
  input[type="text"], input[type="file"]{
    width:100%; padding:12px 12px; background:#0e0e0e; color:var(--text);
    border:1px solid #222; border-radius:10px; outline:none; transition:.15s;
  }
  input[type="text"]:focus{border-color:#333; box-shadow:0 0 0 2px rgba(255,77,77,.2)}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > div{flex:1; min-width:220px}

  .actions{display:flex; gap:10px; margin-top:12px}
  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:700;
    padding:12px 16px; border-radius:10px; transition:.2s; letter-spacing:.2px;
  }
  .btn-primary{background:var(--accent-2); color:white}
  .btn-primary:hover{filter:brightness(1.08)}
  .btn-ghost{background:#161616; color:#fff; border:1px solid #222}
  .btn-ghost:hover{border-color:#333}

  #report-map,#find-map{height:380px; border-radius:12px; overflow:hidden}
  .help{font-size:.85rem; color:var(--sub); margin-top:6px}

  .reports{margin-top:16px; display:grid; gap:12px}
  .report{
    background:#0b0b0b; border:1px solid #1f1f1f; border-left:4px solid var(--accent);
    border-radius:10px; padding:12px; display:grid; gap:6px
  }
  .meta{color:var(--sub); font-size:.85rem}
  .thumbs{display:flex; gap:10px; flex-wrap:wrap}
  .thumbs img,.thumbs video{max-width:180px; border-radius:8px; border:1px solid #222}

  /* Red map marker (CSS-only) */
  .red-pin{
    width:18px; height:18px; background:var(--accent);
    border:2px solid #900; border-radius:50%;
    box-shadow:0 0 0 2px rgba(0,0,0,.25);
  }
  .red-pin::after{
    content:''; position:absolute; top:16px; left:7px; width:4px; height:8px;
    background:#900; transform:rotate(45deg);
  }

  .hidden{display:none}
</style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">SAHARA • Danger Zones</div>
      <div class="badge">Emergency Demo</div>
    </header>

    <h1>⚠ Report & Find Danger Zones</h1>
    <p class="lead">Spot a hazard? Report it with a pin and media. Need awareness? Browse recent danger reports on the map.</p>

    <div class="tabs">
      <button class="tab active" id="tab-report">Report Danger Zone</button>
      <button class="tab" id="tab-find">Find Danger Zones</button>
    </div>

    <!-- REPORT TAB -->
    <section id="panel-report">
      <div class="grid">
        <div class="card">
          <h2>Submit a report</h2>

          <div class="row">
            <div>
              <label for="name">Your Name</label>
              <input type="text" id="name" placeholder="e.g., Aisha Patel" />
            </div>
            <div>
              <label for="address">Danger Zone Location (address)</label>
              <input type="text" id="address" placeholder="e.g., MG Road, Bengaluru" />
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-ghost" id="btn-geocode">Locate on Map</button>
            <button class="btn btn-ghost" id="btn-my-location">Use My Location</button>
          </div>
          <div class="help">Type an address and click “Locate on Map”, or click anywhere on the map to place a red pin.</div>

          <div style="margin:12px 0;"></div>
          <div id="report-map"></div>

          <div class="row" style="margin-top:12px;">
            <div>
              <label for="photo">Upload Photo</label>
              <input type="file" id="photo" accept="image/*">
            </div>
            <div>
              <label for="video">Upload Video</label>
              <input type="file" id="video" accept="video/*">
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-primary" id="btn-submit">Submit Report</button>
            <button class="btn btn-ghost" id="btn-reset">Reset Form</button>
          </div>
          <div class="help">We keep the latest 3 reports for the demo. Data is stored in your browser only (no server).</div>
        </div>

        <div class="card">
          <h2>Latest Reports (3)</h2>
          <div id="reports" class="reports"></div>
        </div>
      </div>
    </section>

    <!-- FIND TAB -->
    <section id="panel-find" class="hidden">
      <div class="grid">
        <div class="card" style="grid-column:1/-1;">
          <h2>Browse reported danger zones</h2>
          <div id="find-map"></div>
          <div class="help">Pins represent recent community submissions. Click a pin to view details.</div>
        </div>
      </div>
    </section>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // ====== State ======
    const storeKey = 'sahara_danger_reports';
    let reports = loadReports();                 // [{name, address, lat, lng, photoURL, videoURL, time}]
    let reportMap, findMap, reportMarker = null; // Leaflet instances
    let redDivIcon;                              // CSS red pin icon

    // ====== Helpers ======
    function loadReports(){
      try { return JSON.parse(localStorage.getItem(storeKey)) || []; }
      catch { return []; }
    }
    function saveReports(){
      localStorage.setItem(storeKey, JSON.stringify(reports));
    }
    function toObjectURL(file){
      return file ? URL.createObjectURL(file) : null;
    }
    function fmtTime(ts){
      const d = new Date(ts);
      return d.toLocaleString();
    }

    // ====== UI: Tabs ======
    const tabReport = document.getElementById('tab-report');
    const tabFind   = document.getElementById('tab-find');
    const panelReport = document.getElementById('panel-report');
    const panelFind   = document.getElementById('panel-find');

    tabReport.addEventListener('click', ()=>{
      tabReport.classList.add('active'); tabFind.classList.remove('active');
      panelReport.classList.remove('hidden'); panelFind.classList.add('hidden');
      setTimeout(()=>{ reportMap.invalidateSize(); }, 150);
    });
    tabFind.addEventListener('click', ()=>{
      tabFind.classList.add('active'); tabReport.classList.remove('active');
      panelFind.classList.remove('hidden'); panelReport.classList.add('hidden');
      setTimeout(()=>{ findMap.invalidateSize(); refreshFindPins(); }, 150);
    });

    // ====== Maps: Init ======
    function createRedIcon(){
      return L.divIcon({ className:'red-pin', iconSize:[18,18] });
    }

    function initMaps(){
      redDivIcon = createRedIcon();

      reportMap = L.map('report-map', { zoomControl: true }).setView([20.5937, 78.9629], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(reportMap);

      // click to drop marker
      reportMap.on('click', (e)=>{
        placeReportMarker(e.latlng);
      });

      findMap = L.map('find-map', { zoomControl: true }).setView([21.5, 78.9], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(findMap);
    }

    function placeReportMarker(latlng){
      if(reportMarker){ reportMap.removeLayer(reportMarker); }
      reportMarker = L.marker(latlng, { icon: redDivIcon }).addTo(reportMap);
      reportMap.panTo(latlng);
    }

    // ====== Geocode (Nominatim) ======
    async function geocodeAddress(q){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers:{ 'Accept-Language':'en' }});
      if(!res.ok) throw new Error('Geocode failed');
      const data = await res.json();
      return data[0] ? { lat:+data[0].lat, lon:+data[0].lon, display:data[0].display_name } : null;
    }

    // ====== Render: Reports List ======
    const reportsEl = document.getElementById('reports');
    function renderReports(){
      reportsEl.innerHTML = '';
      if(reports.length===0){
        reportsEl.innerHTML = `<div class="report"><strong>No reports yet.</strong> Submit your first danger zone.</div>`;
        return;
      }
      reports.slice(0,3).forEach((r,idx)=>{
        const div = document.createElement('div');
        div.className = 'report';
        div.innerHTML = `
          <div><strong>User ${idx+1}:</strong> ${r.name || 'Anonymous'}</div>
          <div class="meta"><strong>Location:</strong> ${r.address || '—'}<br>
          <strong>Coords:</strong> ${r.lat.toFixed(5)}, ${r.lng.toFixed(5)} • <strong>Time:</strong> ${fmtTime(r.time)}</div>
          <div class="thumbs">
            ${r.photoURL ? `<div><div class="meta">Photo</div><img src="${r.photoURL}" alt="photo"></div>`:''}
            ${r.videoURL ? `<div><div class="meta">Video</div><video src="${r.videoURL}" controls></video></div>`:''}
          </div>
        `;
        reportsEl.appendChild(div);
      });
    }

    // ====== Find Map Pins ======
    let findLayerGroup = null;
    function refreshFindPins(){
      if(findLayerGroup){ findMap.removeLayer(findLayerGroup); }
      findLayerGroup = L.layerGroup().addTo(findMap);

      if(reports.length){
        const bounds = [];
        reports.forEach(r=>{
          const m = L.marker([r.lat, r.lng], { icon:redDivIcon })
            .bindPopup(`<strong>${r.name || 'Anonymous'}</strong><br>${r.address || ''}<br>${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}<br><em>${fmtTime(r.time)}</em>`);
          m.addTo(findLayerGroup);
          bounds.push([r.lat, r.lng]);
        });
        if(bounds.length>1){ findMap.fitBounds(bounds, { padding:[40,40] }); }
        else if(bounds.length===1){ findMap.setView(bounds[0], 15); }
      }
    }

    // ====== Events ======
    window.addEventListener('DOMContentLoaded', ()=>{
      initMaps();
      renderReports();
      refreshFindPins();
    });

    // Buttons / Form
    const btnGeocode = document.getElementById('btn-geocode');
    const btnMyLocation = document.getElementById('btn-my-location');
    const btnSubmit = document.getElementById('btn-submit');
    const btnReset = document.getElementById('btn-reset');

    btnGeocode.addEventListener('click', async ()=>{
      const q = document.getElementById('address').value.trim();
      if(!q){ alert('Enter an address first'); return; }
      try{
        const hit = await geocodeAddress(q);
        if(!hit){ alert('No results for that address'); return; }
        reportMap.setView([hit.lat, hit.lon], 15);
        placeReportMarker([hit.lat, hit.lon]);
      }catch(e){ alert('Geocoding error. Try a more specific address.'); }
    });

    btnMyLocation.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude, longitude} = pos.coords;
        reportMap.setView([latitude, longitude], 15);
        placeReportMarker([latitude, longitude]);
      }, ()=>alert('Unable to get your location'));
    });

    btnSubmit.addEventListener('click', ()=>{
      const name = document.getElementById('name').value.trim();
      const address = document.getElementById('address').value.trim();
      const photoFile = document.getElementById('photo').files[0] || null;
      const videoFile = document.getElementById('video').files[0] || null;

      if(!reportMarker){
        alert('Please place the red pin on the map (click the map or use Locate).');
        return;
      }
      const latlng = reportMarker.getLatLng();
      const entry = {
        name, address,
        lat: latlng.lat, lng: latlng.lng,
        photoURL: toObjectURL(photoFile),
        videoURL: toObjectURL(videoFile),
        time: Date.now()
      };
      reports.unshift(entry);
      reports = reports.slice(0,3); // keep 3 for demo
      saveReports();
      renderReports();
      refreshFindPins();

      // Reset lightweight form fields (keep map view)
      document.getElementById('name').value = '';
      document.getElementById('address').value = '';
      document.getElementById('photo').value = '';
      document.getElementById('video').value = '';
      if(reportMarker){ reportMap.removeLayer(reportMarker); reportMarker = null; }

      alert('Report submitted!');
    });

    btnReset.addEventListener('click', ()=>{
      document.getElementById('name').value = '';
      document.getElementById('address').value = '';
      document.getElementById('photo').value = '';
      document.getElementById('video').value = '';
      if(reportMarker){ reportMap.removeLayer(reportMarker); reportMarker = null; }
    });
  </script>
</body>
</html>
