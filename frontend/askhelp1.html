<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ask for Help - SAHARA (Offline-friendly)</title>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f0faff; color:#003366; }
    .container{ max-width:600px; margin:60px auto; padding:30px; background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.05); box-sizing:border-box;}
    h2{ text-align:center; color:#007acc; margin-bottom:8px; }
    p.tagline{ text-align:center; color:#005b99; margin-bottom:22px; font-size:1em;}
    label{ display:block; margin:12px 0 6px; font-weight:500; }
    input, select, textarea{ width:100%; padding:10px; font-size:1em; border:1px solid #cce5ff; border-radius:6px; background:#f9fdff; box-sizing:border-box; }
    textarea{ min-height:90px; resize:vertical; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{ padding:8px 12px; border:none; border-radius:5px; font-size:0.95em; cursor:pointer; }
    .location-btn{ background:#cce5ff; color:#005b99; }
    .location-btn:hover{ background:#b3daff; }
    .map-btn{ background:#ffe0b3; color:#b35a00; }
    .map-btn:hover{ background:#ffd699; }
    button[type="submit"]{ margin-top:20px; width:100%; padding:12px; background:#007acc; color:#fff; border:none; border-radius:6px; font-size:1.05em; cursor:pointer; }
    button[type="submit"]:hover{ background:#005f99; }
    .note{ font-size:0.9em; color:#005b99; margin-top:8px; }
    footer{ text-align:center; padding:18px; background:#eaf6ff; color:#003366; font-size:0.9em; margin-top:32px; }
    .small{ font-size:0.85em; color:#366; }
    .map-container{ display:none; margin-top:15px; }
    .map-container iframe{ width:100%; height:250px; border:0; border-radius:8px; }

    @media (max-width:768px){ .container{ margin:20px; padding:20px; } h2{ font-size:1.45em; } input,select,textarea,button{ font-size:0.95em; } }
    @media (max-width:480px){ .container{ margin:12px; padding:16px; } h2{ font-size:1.25em; } .row{ flex-direction:column; } .btn{ width:100%; padding:10px; } }
  </style>
</head>
<body>
  <div class="container" id="app">
    <h2>Need Help?</h2>
    <p class="tagline">Fill out this quick form and someone nearby will reach out.</p>

    <form id="helpForm" autocomplete="off">
      <label for="name">Your Name</label>
      <input id="name" type="text" required placeholder="e.g. Aisha">

      <label for="location">Your Location</label>
      <div class="row">
        <input id="location" type="text" required placeholder="Fetching your location...">
        <button type="button" class="btn location-btn" id="btnLocation">üìç Share Live</button>
        <button type="button" class="btn map-btn" id="btnMap">üó∫ View on Map</button>
      </div>
      <div class="map-container" id="mapContainer">
        <iframe id="mapFrame" loading="lazy"></iframe>
      </div>

      <label for="type">Type of Help</label>
      <select id="type" required>
        <option value="">-- Select Help Type --</option>
        <option>Medical</option>
        <option>Emotional/Mental Support</option>
        <option>Safety/Escort</option>
        <option>Minor Technical Help</option>
        <option>Lost or Stranded</option>
        <option>Support for Women or LGBTQ+</option>
      </select>

      <label for="description">Describe Your Situation</label>
      <textarea id="description" placeholder="Briefly describe what you‚Äôre facing..." required></textarea>

      <div class="note small" id="status">Not connected to Firebase yet.</div>

      <button type="submit" id="submitBtn">Send Help Request</button>
    </form>
  </div>

  <footer>
    <p>¬© 2025 SAHARA Community | All rights reserved</p>
  </footer>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD6vqtV6apJ41XKyOjYxEIeIzt_DmaLnq0",
      authDomain: "sahara-cb829.firebaseapp.com",
      projectId: "sahara-cb829",
      storageBucket: "sahara-cb829.appspot.com",
      messagingSenderId: "245992709744",
      appId: "1:245992709744:web:a96331ce109d79844fdeb5",
      measurementId: "G-G5LXE5110B"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      document.getElementById('status').textContent = "Connected to Firebase. Ready to send requests.";
      window.db = db;
    } catch (e) {
      console.error('Firebase init error:', e);
      document.getElementById('status').textContent = "‚ö†Ô∏è Firebase init failed ‚Äî check console.";
    }

    // Get location with place name
    let currentCoords = null;
    document.getElementById('btnLocation').addEventListener('click', () => {
      const locationInput = document.getElementById('location');
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }
      document.getElementById('btnLocation').textContent = 'üìç Getting...';

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          currentCoords = { lat, lon };

          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
            const data = await res.json();
            locationInput.value = data.display_name || `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
          } catch {
            locationInput.value = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
          }

          document.getElementById('btnLocation').textContent = 'üìç Share Live';
        },
        () => {
          alert("Unable to access location.");
          document.getElementById('btnLocation').textContent = 'üìç Share Live';
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    // Map preview button
    document.getElementById('btnMap').addEventListener('click', () => {
      if (!currentCoords) {
        alert("Please fetch your location first.");
        return;
      }
      const { lat, lon } = currentCoords;
      document.getElementById('mapFrame').src = `https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}`;
      document.getElementById('mapContainer').style.display = 'block';
    });

    // Submit form
    document.getElementById('helpForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      const name = document.getElementById('name').value.trim();
      const location = document.getElementById('location').value.trim();
      const type = document.getElementById('type').value;
      const description = document.getElementById('description').value.trim();

      if (!name || !location || !type || !description) {
        alert('Please fill all fields.');
        btn.disabled = false;
        btn.textContent = 'Send Help Request';
        return;
      }

      if (!window.firebase || !window.db) {
        alert('Firebase not initialized.');
        btn.disabled = false;
        btn.textContent = 'Send Help Request';
        return;
      }

      try {
        await db.collection('help_requests').add({
          name, location, type, description,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('‚úÖ Request submitted. Stay safe.');
        document.getElementById('helpForm').reset();
        document.getElementById('mapContainer').style.display = 'none';
      } catch (error) {
        console.error('Firestore add error:', error);
        alert('‚ùå Something went wrong.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Send Help Request';
      }
    });
  </script>
</body>
</html>
